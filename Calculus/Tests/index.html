<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .stats-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .stats-section.show {
            display: block;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2rem;
            }
        }

        /* Test page styles */
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .test-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .question-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options {
            list-style: none;
        }

        .option {
            margin-bottom: 15px;
        }

        .option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .option label:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option input[type="radio"] {
            margin-right: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .results-container {
            text-align: center;
            padding: 40px;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 20px;
        }

        .score.low {
            color: #e74c3c;
        }

        .score.medium {
            color: #f39c12;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –¢–µ—Å—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É</h1>
        
        <form id="testForm">
            <div class="form-group">
                <label for="studentName">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:</label>
                <input type="text" id="studentName" name="studentName" required>
                <div class="error" id="nameError"></div>
            </div>

            <div class="form-group">
                <label for="subject">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:</label>
                <select id="subject" name="subject" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª --</option>
                    <option value="derivatives">–ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ</option>
                    <option value="integrals">–ò–Ω—Ç–µ–≥—Ä–∞–ª—ã</option>
                    <option value="limits">–ü—Ä–µ–¥–µ–ª—ã</option>
                    <option value="series">–†—è–¥—ã</option>
                </select>
            </div>

            <div class="form-group">
                <label for="level">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</label>
                <select id="level" name="level" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å --</option>
                    <option value="easy">–õ–µ–≥–∫–∏–π</option>
                    <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="hard">–°–ª–æ–∂–Ω—ã–π</option>
                </select>
            </div>

            <button type="submit" class="btn">üöÄ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
        </form>

        <button type="button" class="btn btn-secondary" onclick="toggleStats()">üìà –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>

        <div class="stats-section" id="statsSection">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
            <div id="statsContent">
                <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            </div>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –±—ã –∏–∑ JSON —Ñ–∞–π–ª–∞)
        const questionsData = {
            derivatives: {
                easy: [
                    {
                        id: 1,
                        question: "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–∏ $f(x) = x^2$",
                        options: ["$2x$", "$x$", "$2x^2$", "$x^2$"],
                        correct: 0
                    },
                    {
                        id: 2,
                        question: "–ß–µ–º—É —Ä–∞–≤–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã $c$?",
                        options: ["$c$", "$0$", "$1$", "$x$"],
                        correct: 1
                    },
                    {
                        id: 3,
                        question: "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é $f(x) = 3x$",
                        options: ["$3$", "$3x$", "$x$", "$0$"],
                        correct: 0
                    },
                    {
                        id: 4,
                        question: "–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–∏ $f(x) = x^3$ —Ä–∞–≤–Ω–∞:",
                        options: ["$x^2$", "$3x^2$", "$3x^3$", "$x^3$"],
                        correct: 1
                    },
                    {
                        id: 5,
                        question: "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é $f(x) = 5x^2 + 2x$",
                        options: ["$10x + 2$", "$5x + 2$", "$10x^2 + 2x$", "$5x^2 + 2$"],
                        correct: 0
                    },
                    {
                        id: 6,
                        question: "–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–∏ $f(x) = \\sin(x)$ —Ä–∞–≤–Ω–∞:",
                        options: ["$\\sin(x)$", "$-\\cos(x)$", "$\\cos(x)$", "$-\\sin(x)$"],
                        correct: 2
                    },
                    {
                        id: 7,
                        question: "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é $f(x) = e^x$",
                        options: ["$e^x$", "$xe^{x-1}$", "$e$", "$x$"],
                        correct: 0
                    },
                    {
                        id: 8,
                        question: "–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è $f(x) = \\ln(x)$ —Ä–∞–≤–Ω–∞:",
                        options: ["$\\frac{1}{x}$", "$\\ln(x)$", "$x$", "$\\frac{1}{\\ln(x)}$"],
                        correct: 0
                    }
                ],
                medium: [
                    {
                        id: 9,
                        question: "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é $f(x) = x^2 \\sin(x)$",
                        options: ["$2x\\sin(x) + x^2\\cos(x)$", "$2x\\cos(x)$", "$x^2\\cos(x)$", "$2x\\sin(x)$"],
                        correct: 0
                    },
                    {
                        id: 10,
                        question: "–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è $f(x) = \\frac{x^2}{x+1}$ —Ä–∞–≤–Ω–∞:",
                        options: ["$\\frac{2x}{x+1}$", "$\\frac{x^2+2x}{(x+1)^2}$", "$\\frac{2x(x+1)-x^2}{(x+1)^2}$", "$\\frac{x(x+2)}{(x+1)^2}$"],
                        correct: 3
                    }
                ],
                hard: [
                    {
                        id: 11,
                        question: "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é $f(x) = x^x$",
                        options: ["$x^x(\\ln(x) + 1)$", "$x^{x-1}$", "$x^x \\ln(x)$", "$x^x$"],
                        correct: 0
                    }
                ]
            },
            integrals: {
                easy: [
                    {
                        id: 12,
                        question: "–ù–∞–π–¥–∏—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞–ª $\\int x dx$",
                        options: ["$\\frac{x^2}{2} + C$", "$x + C$", "$x^2 + C$", "$\\frac{x}{2} + C$"],
                        correct: 0
                    }
                ],
                medium: [],
                hard: []
            },
            limits: {
                easy: [
                    {
                        id: 13,
                        question: "–ù–∞–π–¥–∏—Ç–µ $\\lim_{x \\to 2} (x + 1)$",
                        options: ["$2$", "$3$", "$1$", "$\\infty$"],
                        correct: 1
                    }
                ],
                medium: [],
                hard: []
            },
            series: {
                easy: [
                    {
                        id: 14,
                        question: "–°—É–º–º–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ $1 + \\frac{1}{2} + \\frac{1}{4} + \\frac{1}{8} + ...$",
                        options: ["$1$", "$2$", "$\\frac{3}{2}$", "$\\infty$"],
                        correct: 1
                    }
                ],
                medium: [],
                hard: []
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Ç–µ—Å—Ç
        function isTestPage() {
            return window.location.search.includes('test=true');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            if (isTestPage()) {
                initTest();
            } else {
                initMainPage();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function initMainPage() {
            const form = document.getElementById('testForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmit);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('studentName').value.trim();
            const subject = document.getElementById('subject').value;
            const level = document.getElementById('level').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!name) {
                showError('nameError', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            
            if (name.length < 2) {
                showError('nameError', '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
                return;
            }
            
            clearError('nameError');
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            sessionStorage.setItem('currentUser', JSON.stringify({
                name: escapeHtml(name),
                subject: subject,
                level: level
            }));
            
            // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            const testUrl = `${window.location.href}?test=true&subject=${subject}&level=${level}`;
            window.open(testUrl, '_blank');
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–∫–∏
        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = '';
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function toggleStats() {
            const statsSection = document.getElementById('statsSection');
            const isVisible = statsSection.classList.contains('show');
            
            if (isVisible) {
                statsSection.classList.remove('show');
            } else {
                loadStats();
                statsSection.classList.add('show');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function loadStats() {
            const results = JSON.parse(localStorage.getItem('mathTestResults') || '{}');
            const statsContent = document.getElementById('statsContent');
            
            if (Object.keys(results).length === 0) {
                statsContent.innerHTML = '<p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            let html = '';
            for (const [userName, userResults] of Object.entries(results)) {
                html += `<div class="stats-item">
                    <strong>${escapeHtml(userName)}</strong>
                    <span>–¢–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: ${userResults.length}</span>
                </div>`;
                
                userResults.forEach((result, index) => {
                    const percentage = Math.round((result.score / result.total) * 100);
                    html += `<div class="stats-item">
                        <span>–¢–µ—Å—Ç ${index + 1}: ${result.subject} (${result.level})</span>
                        <span>${result.score}/${result.total} (${percentage}%)</span>
                    </div>`;
                });
            }
            
            statsContent.innerHTML = html;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–∞
        function initTest() {
            document.body.innerHTML = `
                <div class="test-container">
                    <div class="test-header">
                        <h2>–¢–µ—Å—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É</h2>
                        <div class="timer" id="timer">40:00</div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    
                    <div id="testContent"></div>
                </div>
            `;
            
            startTest();
        }

        // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
        function startTest() {
            const urlParams = new URLSearchParams(window.location.search);
            const subject = urlParams.get('subject');
            const level = urlParams.get('level');
            const userData = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            
            if (!subject || !level) {
                document.getElementById('testContent').innerHTML = 
                    '<div class="question-card"><p>–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞</p></div>';
                return;
            }
            
            const questions = questionsData[subject]?.[level] || [];
            if (questions.length === 0) {
                document.getElementById('testContent').innerHTML = 
                    '<div class="question-card"><p>–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p></div>';
                return;
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –∏ –≤—ã–±–æ—Ä 20 –≤–æ–ø—Ä–æ—Å–æ–≤ (–∏–ª–∏ –º–µ–Ω—å—à–µ, –µ—Å–ª–∏ –∏—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
            const shuffledQuestions = [...questions].sort(() => Math.random() - 0.5);
            const selectedQuestions = shuffledQuestions.slice(0, Math.min(20, shuffledQuestions.length));
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–µ—Å—Ç–∞
            window.testState = {
                questions: selectedQuestions,
                currentQuestion: 0,
                answers: {},
                timeLeft: 40 * 60, // 40 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                subject: subject,
                level: level,
                userName: userData.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
            };
            
            startTimer();
            showQuestion();
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        function startTimer() {
            const timer = setInterval(() => {
                window.testState.timeLeft--;
                updateTimerDisplay();
                
                if (window.testState.timeLeft <= 0) {
                    clearInterval(timer);
                    finishTest();
                }
            }, 1000);
            
            window.testTimer = timer;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
        function updateTimerDisplay() {
            const minutes = Math.floor(window.testState.timeLeft / 60);
            const seconds = window.testState.timeLeft % 60;
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
                if (window.testState.timeLeft < 300) { // –º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç
                    timerElement.style.color = '#e74c3c';
                }
            }
        }

        // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞
        function showQuestion() {
            const state = window.testState;
            const question = state.questions[state.currentQuestion];
            
            if (!question) {
                finishTest();
                return;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            const progress = ((state.currentQuestion + 1) / state.questions.length) * 100;
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
            
            const testContent = document.getElementById('testContent');
            testContent.innerHTML = `
                <div class="question-card">
                    <div class="question-text">
                        <strong>–í–æ–ø—Ä–æ—Å ${state.currentQuestion + 1} –∏–∑ ${state.questions.length}</strong><br><br>
                        ${question.question}
                    </div>
                    
                    <ul class="options">
                        ${question.options.map((option, index) => `
                            <li class="option">
                                <label>
                                    <input type="radio" name="answer" value="${index}" 
                                           ${state.answers[question.id] === index ? 'checked' : ''}>
                                    ${option}
                                </label>
                            </li>
                        `).join('')}
                    </ul>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        ${state.currentQuestion > 0 ? 
                            '<button class="btn btn-secondary" onclick="previousQuestion()">‚Üê –ù–∞–∑–∞–¥</button>' : 
                            '<div></div>'
                        }
                        <button class="btn" onclick="nextQuestion()">
                            ${state.currentQuestion === state.questions.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç' : '–î–∞–ª–µ–µ ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
            const radioButtons = testContent.querySelectorAll('input[name="answer"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    state.answers[question.id] = parseInt(e.target.value);
                });
            });
            
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([testContent]).catch((err) => console.log(err));
            }
        }

        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        function nextQuestion() {
            const state = window.testState;
            
            if (state.currentQuestion === state.questions.length - 1) {
                finishTest();
            } else {
                state.currentQuestion++;
                showQuestion();
            }
        }

        // –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å
        function previousQuestion() {
            const state = window.testState;
            
            if (state.currentQuestion > 0) {
                state.currentQuestion--;
                showQuestion();
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
        function finishTest() {
            if (window.testTimer) {
                clearInterval(window.testTimer);
            }
            
            const state = window.testState;
            let correctAnswers = 0;
            
            // –ü–æ–¥—Å—á–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            state.questions.forEach(question => {
                if (state.answers[question.id] === question.correct) {
                    correctAnswers++;
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            saveTestResult(correctAnswers, state.questions.length);
            
            // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            showResults(correctAnswers, state.questions.length);
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–∞
        function saveTestResult(score, total) {
            const state = window.testState;
            const results = JSON.parse(localStorage.getItem('mathTestResults') || '{}');
            
            if (!results[state.userName]) {
                results[state.userName] = [];
            }
            
            results[state.userName].push({
                date: new Date().toISOString(),
                subject: state.subject,
                level: state.level,
                score: score,
                total: total,
                timeSpent: (40 * 60) - state.timeLeft
            });
            
            localStorage.setItem('mathTestResults', JSON.stringify(results));
        }

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function showResults(score, total) {
            const percentage = Math.round((score / total) * 100);
            let scoreClass = 'low';
            let message = '–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏!';
            
            if (percentage >= 80) {
                scoreClass = 'high';
                message = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üéâ';
            } else if (percentage >= 60) {
                scoreClass = 'medium';
                message = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üëç';
            }
            
            document.body.innerHTML = `
                <div class="container results-container">
                    <h1>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h1>
                    
                    <div class="score ${scoreClass}">
                        ${score}/${total}
                    </div>
                    
                    <p style="font-size: 1.2rem; margin-bottom: 10px;">
                        –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <strong>${percentage}%</strong>
                    </p>
                    
                    <p style="font-size: 1.1rem; margin-bottom: 30px; color: #666;">
                        ${message}
                    </p>
                    
                    <button class="btn" onclick="returnToMain()">
                        üè† –í—ã–π—Ç–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    </button>
                </div>
            `;
        }

        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        function returnToMain() {
            window.close();
            // –ï—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –±–ª–æ–∫–∏—Ä—É—é—Ç), –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
            setTimeout(() => {
                window.location.href = window.location.origin + window.location.pathname;
            }, 100);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'980285bf65c3e950',t:'MTc1ODA0ODM0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
